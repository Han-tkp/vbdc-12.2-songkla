---
// ส่วนที่ 1: "Backend" ของ Astro (รันตอน Build)
// เราจะดึงข้อมูลข้อความทั้งหมดมาแสดงตอนโหลดหน้าเว็บครั้งแรก
// Astro จะเรียก API ของเราเอง (ที่สร้างในขั้นตอนที่ 3)

let allMessages = [];
try {
  // นี่คือการเรียก API ภายใน (ถ้าทดสอบในเครื่อง) หรือเรียก API ที่ Deploy แล้ว
  // เราใช้ "Astro.url.origin" เพื่อให้มันรู้ว่าต้องเรียก API ที่ไหน
  const response = await fetch(`${Astro.url.origin}/api/messages`);
  if (response.ok) {
    allMessages = await response.json();
  }
} catch (error) {
  console.error(error);
}
---

<html lang="th">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="viewport" content="width=device-width" />
  <meta name="generator" content={Astro.generator} />
  <title>สมุดเยี่ยม ศตม.</title>
</head>
<body class="bg-gray-100 text-gray-900">
  
  <main class="max-w-2xl mx-auto p-8">
    <h1 class="text-3xl font-bold mb-6 text-blue-800">สมุดเยี่ยม (Guestbook)</h1>

    <form id="guestbook-form" class="bg-white p-6 rounded-lg shadow-md mb-8">
      <div class="mb-4">
        <label for="name" class="block text-sm font-medium text-gray-700">ชื่อ:</label>
        <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="mb-4">
        <label for="message" class="block text-sm font-medium text-gray-700">ข้อความ:</label>
        <textarea id="message" name="message" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
      </div>
      <button type"submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
        ส่งข้อความ
      </button>
      <p id="form-status" class="text-sm mt-4 text-center"></p>
    </form>

    <h2 class="text-2xl font-semibold mb-4">ข้อความทั้งหมด</h2>
    <div id="messages-list" class="space-y-4">
      {allMessages.length > 0 ? (
        allMessages.map((msg) => (
          <div class="bg-white p-4 rounded-lg shadow">
            <p class="font-bold">{msg.name}</p>
            <p class="text-gray-700">{msg.message_text}</p>
            <p class="text-xs text-gray-500 mt-2">
              {new Date(msg.created_at).toLocaleString('th-TH')}
            </p>
          </div>
        ))
      ) : (
        <p class="text-gray-500">ยังไม่มีข้อความ...</p>
      )}
    </div>

  </main>

  <script>
    const form = document.getElementById('guestbook-form');
    const statusEl = document.getElementById('form-status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // หยุดการ submit แบบปกติ
      
      const formData = new FormData(form);
      const name = formData.get('name');
      const message = formData.get('message');

      statusEl.textContent = 'กำลังส่ง...';

      try {
        const response = await fetch('/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, message }),
        });

        if (!response.ok) {
          throw new Error('Server ตอบกลับมามีปัญหา');
        }

        // ถ้าสำเร็จ
        statusEl.textContent = 'ส่งข้อความสำเร็จ!';
        form.reset(); // ล้างฟอร์ม
        
        // (ขั้นสูง) ปกติเราจะ refresh list ตรงนี้ แต่เพื่อความง่าย เราจะ reload หน้า
        setTimeout(() => {
          location.reload(); 
        }, 1000);

      } catch (error) {
        console.error(error);
        statusEl.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
      }
    });
  </script>
</body>
</html>